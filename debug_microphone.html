<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Microphone Debug</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .debug-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .success {
                background: #d4edda;
                border-color: #c3e6cb;
            }
            .error {
                background: #f8d7da;
                border-color: #f5c6cb;
            }
            .warning {
                background: #fff3cd;
                border-color: #ffeaa7;
            }
            .info {
                background: #d1ecf1;
                border-color: #bee5eb;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #0056b3;
            }
            pre {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 5px;
                overflow-x: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîß Microphone Debug Tool</h1>
            <p>
                This tool helps debug microphone issues in the Shopping
                Assistant extension.
            </p>

            <div class="debug-section info">
                <h3>Environment Check</h3>
                <div id="envCheck"></div>
            </div>

            <div class="debug-section info">
                <h3>Extension Context</h3>
                <div id="extensionCheck"></div>
            </div>

            <div class="debug-section info">
                <h3>Current Tab Info</h3>
                <div id="tabInfo"></div>
            </div>

            <div class="debug-section info">
                <h3>Microphone Test</h3>
                <button onclick="testDirectMicrophone()">
                    Test Direct Microphone
                </button>
                <button onclick="testTabCapture()">Test Tab Capture</button>
                <div id="microphoneTest"></div>
            </div>

            <div class="debug-section info">
                <h3>Console Logs</h3>
                <div id="consoleLogs"></div>
            </div>
        </div>

        <script>
            // Capture console logs
            const originalLog = console.log;
            const originalError = console.error;
            const logContainer = document.getElementById("consoleLogs");

            function addLog(message, type = "log") {
                const div = document.createElement("div");
                div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                div.style.color = type === "error" ? "red" : "blue";
                logContainer.appendChild(div);
            }

            console.log = function (...args) {
                originalLog.apply(console, args);
                addLog(args.join(" "));
            };

            console.error = function (...args) {
                originalError.apply(console, args);
                addLog(args.join(" "), "error");
            };

            // Environment check
            function checkEnvironment() {
                const envCheck = document.getElementById("envCheck");
                const checks = [
                    {
                        name: "HTTPS/Secure Context",
                        value: window.isSecureContext,
                    },
                    {
                        name: "getUserMedia Available",
                        value: !!(
                            navigator.mediaDevices &&
                            navigator.mediaDevices.getUserMedia
                        ),
                    },
                    {
                        name: "MediaRecorder Available",
                        value: !!window.MediaRecorder,
                    },
                    {
                        name: "Chrome Extension Context",
                        value: !!(
                            typeof chrome !== "undefined" && chrome.runtime
                        ),
                    },
                    {
                        name: "Tab Capture Available",
                        value: !!(
                            typeof chrome !== "undefined" && chrome.tabCapture
                        ),
                    },
                ];

                let html = "";
                checks.forEach((check) => {
                    const status = check.value ? "‚úÖ" : "‚ùå";
                    const color = check.value ? "green" : "red";
                    html += `<div style="color: ${color}">${status} ${check.name}: ${check.value}</div>`;
                });
                envCheck.innerHTML = html;
            }

            // Extension context check
            function checkExtensionContext() {
                const extensionCheck =
                    document.getElementById("extensionCheck");
                let html = "";

                if (typeof chrome !== "undefined") {
                    html +=
                        '<div style="color: green">‚úÖ Chrome API available</div>';
                    if (chrome.runtime) {
                        html +=
                            '<div style="color: green">‚úÖ Chrome Runtime available</div>';
                        html += `<div>Extension ID: ${
                            chrome.runtime.id || "Not available"
                        }</div>`;
                    }
                    if (chrome.tabCapture) {
                        html +=
                            '<div style="color: green">‚úÖ Tab Capture available</div>';
                    } else {
                        html +=
                            '<div style="color: red">‚ùå Tab Capture not available</div>';
                    }
                } else {
                    html +=
                        '<div style="color: red">‚ùå Chrome API not available</div>';
                }

                extensionCheck.innerHTML = html;
            }

            // Current tab info
            async function getTabInfo() {
                const tabInfo = document.getElementById("tabInfo");

                if (typeof chrome !== "undefined" && chrome.tabs) {
                    try {
                        const [tab] = await chrome.tabs.query({
                            active: true,
                            currentWindow: true,
                        });
                        if (tab) {
                            tabInfo.innerHTML = `
                            <div><strong>URL:</strong> ${tab.url}</div>
                            <div><strong>Title:</strong> ${tab.title}</div>
                            <div><strong>Protocol:</strong> ${
                                new URL(tab.url).protocol
                            }</div>
                            <div><strong>Tab ID:</strong> ${tab.id}</div>
                        `;
                        } else {
                            tabInfo.innerHTML =
                                '<div style="color: red">‚ùå No active tab found</div>';
                        }
                    } catch (error) {
                        tabInfo.innerHTML = `<div style="color: red">‚ùå Error getting tab info: ${error.message}</div>`;
                    }
                } else {
                    tabInfo.innerHTML =
                        '<div style="color: red">‚ùå Chrome tabs API not available</div>';
                }
            }

            // Test direct microphone
            async function testDirectMicrophone() {
                const microphoneTest =
                    document.getElementById("microphoneTest");
                microphoneTest.innerHTML =
                    "<div>Testing direct microphone access...</div>";

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100,
                        },
                    });

                    microphoneTest.innerHTML =
                        '<div style="color: green">‚úÖ Direct microphone access successful!</div>';

                    // Clean up
                    stream.getTracks().forEach((track) => track.stop());
                } catch (error) {
                    microphoneTest.innerHTML = `
                    <div style="color: red">‚ùå Direct microphone access failed</div>
                    <div><strong>Error:</strong> ${error.name}</div>
                    <div><strong>Message:</strong> ${error.message}</div>
                `;
                }
            }

            // Test tab capture
            async function testTabCapture() {
                const microphoneTest =
                    document.getElementById("microphoneTest");
                microphoneTest.innerHTML = "<div>Testing tab capture...</div>";

                if (typeof chrome === "undefined" || !chrome.runtime) {
                    microphoneTest.innerHTML =
                        '<div style="color: red">‚ùå Chrome extension context not available</div>';
                    return;
                }

                try {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage(
                            { type: "REQUEST_TAB_CAPTURE" },
                            resolve
                        );
                    });

                    if (response.success) {
                        microphoneTest.innerHTML =
                            '<div style="color: green">‚úÖ Tab capture successful!</div>';
                    } else {
                        microphoneTest.innerHTML = `
                        <div style="color: red">‚ùå Tab capture failed</div>
                        <div><strong>Error:</strong> ${response.error}</div>
                        <div><strong>Details:</strong> ${
                            response.details || "None"
                        }</div>
                    `;
                    }
                } catch (error) {
                    microphoneTest.innerHTML = `
                    <div style="color: red">‚ùå Tab capture test failed</div>
                    <div><strong>Error:</strong> ${error.message}</div>
                `;
                }
            }

            // Initialize
            window.addEventListener("load", () => {
                checkEnvironment();
                checkExtensionContext();
                getTabInfo();
            });
        </script>
    </body>
</html>
