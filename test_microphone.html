<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Microphone Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .status {
                margin: 20px 0;
                padding: 15px;
                border-radius: 6px;
                font-weight: bold;
            }
            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            .recording {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ðŸŽ¤ Microphone Test</h1>
            <p>
                This page tests microphone functionality for the Shopping
                Assistant extension.
            </p>

            <div id="status" class="status info">
                Ready to test microphone access
            </div>

            <div>
                <button id="testBtn" onclick="testMicrophone()">
                    Test Microphone Access
                </button>
                <button id="recordBtn" onclick="toggleRecording()" disabled>
                    Start Recording
                </button>
                <button id="stopBtn" onclick="stopRecording()" disabled>
                    Stop Recording
                </button>
            </div>

            <div id="results">
                <h3>Test Results:</h3>
                <ul id="resultList"></ul>
            </div>
        </div>

        <script>
            let mediaRecorder = null;
            let audioChunks = [];
            let isRecording = false;
            let stream = null;

            function updateStatus(message, type = "info") {
                const status = document.getElementById("status");
                status.textContent = message;
                status.className = `status ${type}`;
            }

            function addResult(message, type = "info") {
                const list = document.getElementById("resultList");
                const li = document.createElement("li");
                li.textContent = message;
                li.style.color =
                    type === "error"
                        ? "red"
                        : type === "success"
                        ? "green"
                        : "blue";
                list.appendChild(li);
            }

            async function testMicrophone() {
                updateStatus("Testing microphone access...", "info");
                addResult("Testing microphone access...");

                try {
                    // Test if we're in a Chrome extension context
                    if (typeof chrome !== "undefined" && chrome.runtime) {
                        addResult(
                            "âœ“ Chrome extension context detected",
                            "success"
                        );
                    } else {
                        addResult("âš  Not in Chrome extension context", "error");
                    }

                    // Test if getUserMedia is available
                    if (
                        navigator.mediaDevices &&
                        navigator.mediaDevices.getUserMedia
                    ) {
                        addResult("âœ“ getUserMedia API available", "success");
                    } else {
                        addResult("âœ— getUserMedia API not available", "error");
                        return;
                    }

                    // Test if tabCapture is available (for extensions)
                    if (typeof chrome !== "undefined" && chrome.tabCapture) {
                        addResult("âœ“ tabCapture API available", "success");
                    } else {
                        addResult(
                            "âš  tabCapture API not available (may not be in extension context)",
                            "info"
                        );
                    }

                    // Try to get microphone access
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100,
                        },
                    });

                    addResult("âœ“ Microphone access granted!", "success");
                    updateStatus("Microphone access successful!", "success");

                    // Enable recording button
                    document.getElementById("recordBtn").disabled = false;
                } catch (error) {
                    addResult(
                        `âœ— Microphone access failed: ${error.name}`,
                        "error"
                    );
                    addResult(`Error details: ${error.message}`, "error");
                    updateStatus(
                        `Microphone access failed: ${error.name}`,
                        "error"
                    );
                }
            }

            function toggleRecording() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            }

            function startRecording() {
                if (!stream) {
                    addResult("âœ— No microphone stream available", "error");
                    return;
                }

                try {
                    const mimeType = MediaRecorder.isTypeSupported("audio/webm")
                        ? "audio/webm"
                        : "audio/ogg";

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, {
                            type: mimeType,
                        });
                        addResult(
                            `âœ“ Recording completed: ${audioBlob.size} bytes`,
                            "success"
                        );

                        // Create audio element to play back
                        const audio = document.createElement("audio");
                        audio.controls = true;
                        audio.src = URL.createObjectURL(audioBlob);
                        document.getElementById("results").appendChild(audio);
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    document.getElementById("recordBtn").textContent =
                        "Stop Recording";
                    document.getElementById("stopBtn").disabled = false;
                    updateStatus("Recording... Click to stop", "recording");
                    addResult("âœ“ Recording started", "success");
                } catch (error) {
                    addResult(
                        `âœ— Failed to start recording: ${error.message}`,
                        "error"
                    );
                }
            }

            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;

                    document.getElementById("recordBtn").textContent =
                        "Start Recording";
                    document.getElementById("stopBtn").disabled = true;
                    updateStatus("Recording stopped", "info");
                }
            }

            // Clean up when page unloads
            window.addEventListener("beforeunload", () => {
                if (stream) {
                    stream.getTracks().forEach((track) => track.stop());
                }
            });
        </script>
    </body>
</html>
