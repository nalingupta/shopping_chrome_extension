<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Offscreen Document Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .status {
                margin: 20px 0;
                padding: 15px;
                border-radius: 6px;
                font-weight: bold;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .recording {
                background: #dc3545 !important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>🔧 Offscreen Document Test</h1>
            <p>
                This page tests the offscreen document functionality for voice
                input.
            </p>

            <div id="status" class="status info">
                Ready to test offscreen document
            </div>

            <div>
                <button id="testBtn" onclick="testOffscreenDocument()">
                    Test Offscreen Document
                </button>
                <button id="permissionBtn" onclick="checkPermission()">
                    Check Microphone Permission
                </button>
                <button id="recordBtn" onclick="toggleRecording()" disabled>
                    Start Recording
                </button>
            </div>

            <div id="results">
                <h3>Test Results:</h3>
                <div id="resultList"></div>
            </div>
        </div>

        <script>
            let isRecording = false;

            function updateStatus(message, type = "info") {
                const status = document.getElementById("status");
                status.textContent = message;
                status.className = `status ${type}`;
            }

            function addResult(message, type = "info") {
                const list = document.getElementById("resultList");
                const div = document.createElement("div");
                div.textContent = message;
                div.style.color =
                    type === "error"
                        ? "red"
                        : type === "success"
                        ? "green"
                        : "blue";
                div.style.margin = "5px 0";
                list.appendChild(div);
            }

            async function testOffscreenDocument() {
                updateStatus("Testing offscreen document...", "info");
                addResult("Testing offscreen document...");

                try {
                    // Check if we're in a Chrome extension context
                    if (typeof chrome !== "undefined" && chrome.runtime) {
                        addResult(
                            "✅ Chrome extension context detected",
                            "success"
                        );

                        // Test if offscreen document exists
                        const response = await new Promise((resolve) => {
                            chrome.runtime.sendMessage(
                                { type: "CHECK_MICROPHONE_PERMISSION" },
                                resolve
                            );
                        });

                        if (response && response.success) {
                            addResult(
                                "✅ Offscreen document is working!",
                                "success"
                            );
                            updateStatus(
                                "Offscreen document is working!",
                                "success"
                            );
                            document.getElementById(
                                "permissionBtn"
                            ).disabled = false;
                            document.getElementById(
                                "recordBtn"
                            ).disabled = false;
                        } else {
                            addResult(
                                `❌ Offscreen document failed: ${
                                    response?.error || "Unknown error"
                                }`,
                                "error"
                            );
                            updateStatus("Offscreen document failed", "error");
                        }
                    } else {
                        addResult("⚠ Not in Chrome extension context", "error");
                        updateStatus(
                            "Please test this from within the extension",
                            "error"
                        );
                    }
                } catch (error) {
                    addResult(`❌ Test failed: ${error.message}`, "error");
                    updateStatus("Test failed", "error");
                }
            }

            async function checkPermission() {
                updateStatus("Checking microphone permission...", "info");
                addResult("Checking microphone permission...");

                try {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage(
                            { type: "CHECK_MICROPHONE_PERMISSION" },
                            resolve
                        );
                    });

                    if (response && response.success) {
                        addResult(
                            "✅ Microphone permission granted!",
                            "success"
                        );
                        updateStatus(
                            "Microphone permission granted!",
                            "success"
                        );
                    } else {
                        addResult(
                            `❌ Microphone permission failed: ${
                                response?.error || "Unknown error"
                            }`,
                            "error"
                        );
                        updateStatus("Microphone permission failed", "error");
                    }
                } catch (error) {
                    addResult(
                        `❌ Permission check failed: ${error.message}`,
                        "error"
                    );
                    updateStatus("Permission check failed", "error");
                }
            }

            function toggleRecording() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            }

            async function startRecording() {
                try {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage(
                            { type: "START_VOICE_RECORDING" },
                            resolve
                        );
                    });

                    if (response && response.success) {
                        isRecording = true;
                        document.getElementById("recordBtn").textContent =
                            "Stop Recording";
                        document
                            .getElementById("recordBtn")
                            .classList.add("recording");
                        updateStatus("Recording... Click to stop", "info");
                        addResult("✅ Recording started", "success");
                    } else {
                        addResult(
                            `❌ Failed to start recording: ${
                                response?.error || "Unknown error"
                            }`,
                            "error"
                        );
                    }
                } catch (error) {
                    addResult(`❌ Recording failed: ${error.message}`, "error");
                }
            }

            async function stopRecording() {
                try {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage(
                            { type: "STOP_VOICE_RECORDING" },
                            resolve
                        );
                    });

                    if (response && response.success) {
                        isRecording = false;
                        document.getElementById("recordBtn").textContent =
                            "Start Recording";
                        document
                            .getElementById("recordBtn")
                            .classList.remove("recording");
                        updateStatus("Recording stopped", "info");
                        addResult("✅ Recording stopped", "success");
                    } else {
                        addResult(
                            `❌ Failed to stop recording: ${
                                response?.error || "Unknown error"
                            }`,
                            "error"
                        );
                    }
                } catch (error) {
                    addResult(
                        `❌ Stop recording failed: ${error.message}`,
                        "error"
                    );
                }
            }

            // Listen for audio data
            chrome.runtime.onMessage.addListener(
                (request, sender, sendResponse) => {
                    if (request.type === "AUDIO_DATA_RECEIVED") {
                        addResult("✅ Audio data received!", "success");
                        addResult(
                            `Audio size: ${request.audioBlob?.size || 0} bytes`,
                            "info"
                        );
                    }
                }
            );
        </script>
    </body>
</html>
