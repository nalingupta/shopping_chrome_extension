<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Voice Input Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .status {
                margin: 20px 0;
                padding: 15px;
                border-radius: 6px;
                font-weight: bold;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
            .info {
                background: #d1ecf1;
                color: #0c5460;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .recording {
                background: #dc3545 !important;
            }
            .instructions {
                background: #e7f3ff;
                padding: 15px;
                border-radius: 6px;
                margin: 20px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ðŸŽ¤ Voice Input Test</h1>

            <div class="instructions">
                <h3>How to Test Voice Input:</h3>
                <ol>
                    <li>
                        Make sure the Shopping Assistant extension is loaded
                    </li>
                    <li>Navigate to a regular website (like google.com)</li>
                    <li>Open the extension side panel</li>
                    <li>Click the microphone button</li>
                    <li>
                        If it works, the button should turn red and you can
                        speak
                    </li>
                </ol>
            </div>

            <div id="status" class="status info">Ready to test voice input</div>

            <div>
                <button id="testBtn" onclick="testVoiceInput()">
                    Test Voice Input
                </button>
                <button id="recordBtn" onclick="toggleRecording()" disabled>
                    Start Recording
                </button>
            </div>

            <div id="results">
                <h3>Test Results:</h3>
                <div id="resultList"></div>
            </div>
        </div>

        <script>
            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];
            let stream = null;

            function updateStatus(message, type = "info") {
                const status = document.getElementById("status");
                status.textContent = message;
                status.className = `status ${type}`;
            }

            function addResult(message, type = "info") {
                const list = document.getElementById("resultList");
                const div = document.createElement("div");
                div.textContent = message;
                div.style.color =
                    type === "error"
                        ? "red"
                        : type === "success"
                        ? "green"
                        : "blue";
                div.style.margin = "5px 0";
                list.appendChild(div);
            }

            async function testVoiceInput() {
                updateStatus("Testing voice input...", "info");
                addResult("Testing voice input...");

                try {
                    // Check if we're in a Chrome extension context
                    if (typeof chrome !== "undefined" && chrome.runtime) {
                        addResult(
                            "âœ… Chrome extension context detected",
                            "success"
                        );

                        // Test tab capture
                        const response = await new Promise((resolve) => {
                            chrome.runtime.sendMessage(
                                { type: "REQUEST_TAB_CAPTURE" },
                                resolve
                            );
                        });

                        if (response.success) {
                            addResult("âœ… Tab capture successful!", "success");
                            updateStatus("Voice input should work!", "success");
                            document.getElementById(
                                "recordBtn"
                            ).disabled = false;
                        } else {
                            addResult(
                                `âŒ Tab capture failed: ${response.error}`,
                                "error"
                            );
                            addResult(
                                `Details: ${response.details || "None"}`,
                                "error"
                            );
                            updateStatus(
                                "Voice input not available on this page",
                                "error"
                            );

                            // Provide helpful suggestions
                            addResult(
                                "ðŸ’¡ Try navigating to a different website",
                                "info"
                            );
                            addResult(
                                "ðŸ’¡ Make sure you're on a regular website (not chrome:// pages)",
                                "info"
                            );
                        }
                    } else {
                        addResult("âš  Not in Chrome extension context", "error");
                        updateStatus(
                            "Please test this from within the extension",
                            "error"
                        );
                    }
                } catch (error) {
                    addResult(`âŒ Test failed: ${error.message}`, "error");
                    updateStatus("Test failed", "error");
                }
            }

            function toggleRecording() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            }

            async function startRecording() {
                try {
                    const response = await new Promise((resolve) => {
                        chrome.runtime.sendMessage(
                            { type: "REQUEST_TAB_CAPTURE" },
                            resolve
                        );
                    });

                    if (!response.success) {
                        addResult(
                            "âŒ Cannot start recording: Tab capture failed",
                            "error"
                        );
                        return;
                    }

                    // Convert stream ID to MediaStream
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            mandatory: {
                                chromeMediaSource: "tab",
                                chromeMediaSourceId: response.streamId,
                            },
                        },
                    });

                    const mimeType = MediaRecorder.isTypeSupported("audio/webm")
                        ? "audio/webm"
                        : "audio/ogg";

                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, {
                            type: mimeType,
                        });
                        addResult(
                            `âœ… Recording completed: ${audioBlob.size} bytes`,
                            "success"
                        );

                        // Create audio element to play back
                        const audio = document.createElement("audio");
                        audio.controls = true;
                        audio.src = URL.createObjectURL(audioBlob);
                        document.getElementById("results").appendChild(audio);
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    document.getElementById("recordBtn").textContent =
                        "Stop Recording";
                    document
                        .getElementById("recordBtn")
                        .classList.add("recording");
                    updateStatus("Recording... Click to stop", "info");
                    addResult("âœ… Recording started", "success");
                } catch (error) {
                    addResult(
                        `âŒ Failed to start recording: ${error.message}`,
                        "error"
                    );
                }
            }

            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;

                    document.getElementById("recordBtn").textContent =
                        "Start Recording";
                    document
                        .getElementById("recordBtn")
                        .classList.remove("recording");
                    updateStatus("Recording stopped", "info");
                }
            }

            // Clean up when page unloads
            window.addEventListener("beforeunload", () => {
                if (stream) {
                    stream.getTracks().forEach((track) => track.stop());
                }
            });
        </script>
    </body>
</html>
