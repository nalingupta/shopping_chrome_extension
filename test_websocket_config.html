<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebSocket Configuration Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .log {
                background: #f5f5f5;
                padding: 10px;
                margin: 10px 0;
                border-radius: 5px;
            }
            .success {
                color: green;
            }
            .error {
                color: red;
            }
            .warning {
                color: orange;
            }
        </style>
    </head>
    <body>
        <h1>WebSocket Configuration Test</h1>
        <div id="output"></div>

        <script type="module">
            function log(message, type = "info") {
                const output = document.getElementById("output");
                const div = document.createElement("div");
                div.className = `log ${type}`;
                div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                output.appendChild(div);
            }

            // Test the WebSocket configuration format
            function testWebSocketConfig() {
                log("🧪 Testing WebSocket Configuration Format...", "info");

                // Test 1: Configuration message format
                const configMessage = {
                    setup: {
                        model: "models/gemini-2.0-flash-exp",
                        systemInstruction: {
                            parts: [
                                {
                                    text: "You are a helpful shopping assistant that helps users with their shopping needs. You can analyze web pages, answer questions about products, and provide shopping advice.",
                                },
                            ],
                        },
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                            responseModalities: ["TEXT"],
                        },
                    },
                };

                log("✅ Configuration message structure:", "success");
                log(`   Model: ${configMessage.setup.model}`, "info");
                log(
                    `   System instruction length: ${configMessage.setup.systemInstruction.parts[0].text.length} chars`,
                    "info"
                );
                log(
                    `   Generation config keys: ${Object.keys(
                        configMessage.setup.generationConfig
                    ).join(", ")}`,
                    "info"
                );

                // Test 2: Keep-alive message format
                const keepAliveMessage = {
                    realtimeInput: {
                        mediaChunks: [],
                    },
                };

                log("✅ Keep-alive message structure:", "success");
                log(
                    `   Keys: ${Object.keys(keepAliveMessage).join(", ")}`,
                    "info"
                );

                // Test 3: Text message format
                const textMessage = {
                    clientContent: {
                        turns: [
                            {
                                role: "user",
                                parts: [
                                    {
                                        text: "Hello, can you help me with shopping?",
                                    },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: "base64data...",
                                        },
                                    },
                                ],
                            },
                        ],
                    },
                };

                log("✅ Text message structure:", "success");
                log(
                    `   Turns count: ${textMessage.clientContent.turns.length}`,
                    "info"
                );
                log(
                    `   First turn role: ${textMessage.clientContent.turns[0].role}`,
                    "info"
                );
                log(
                    `   Parts count: ${textMessage.clientContent.turns[0].parts.length}`,
                    "info"
                );

                // Test 4: JSON serialization
                try {
                    const configJson = JSON.stringify(configMessage);
                    const keepAliveJson = JSON.stringify(keepAliveMessage);
                    const textJson = JSON.stringify(textMessage);

                    log("✅ JSON serialization successful:", "success");
                    log(`   Config size: ${configJson.length} chars`, "info");
                    log(
                        `   Keep-alive size: ${keepAliveJson.length} chars`,
                        "info"
                    );
                    log(
                        `   Text message size: ${textJson.length} chars`,
                        "info"
                    );

                    // Test parsing back
                    JSON.parse(configJson);
                    JSON.parse(keepAliveJson);
                    JSON.parse(textJson);
                    log("✅ JSON parsing successful:", "success");
                } catch (error) {
                    log(
                        `❌ JSON serialization/parsing failed: ${error.message}`,
                        "error"
                    );
                }

                // Test 5: Setup completion detection
                const setupCompletionTests = [
                    { setupComplete: true },
                    { setup_complete: true },
                    { setupCompleted: true },
                    { serverContent: { setupComplete: true } },
                    { serverContent: { setup: true } },
                    { setup: { complete: true } },
                    { serverContent: { turns: [] } }, // Fallback detection
                ];

                log("🧪 Testing setup completion detection...", "info");
                setupCompletionTests.forEach((test, index) => {
                    const hasSetupComplete =
                        test.setupComplete !== undefined ||
                        test.setup_complete !== undefined ||
                        test.setupCompleted !== undefined ||
                        (test.serverContent &&
                            test.serverContent.setupComplete) ||
                        (test.serverContent && test.serverContent.setup) ||
                        (test.setup && test.setup.complete) ||
                        (!test.setupComplete && test.serverContent); // Fallback

                    log(
                        `   Test ${index + 1}: ${
                            hasSetupComplete ? "✅" : "❌"
                        } ${JSON.stringify(test)}`,
                        hasSetupComplete ? "success" : "error"
                    );
                });

                log("🎉 WebSocket configuration test completed!", "success");
            }

            // Run the test
            testWebSocketConfig();
        </script>
    </body>
</html>
